<!DOCTYPE html>
<html lang="en">
<head>
  <title>AI Avatar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/livekit-client@2.9.9/dist/livekit-client.umd.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    #volumeBar {
      height: 10px;
      background: green;
      margin-top: 5px;
      transition: width 0.1s;
    }
  </style>
</head>
<body class="bg-gray-100 p-5 font-sans">
  <div class="max-w-3xl mx-auto bg-white p-5 rounded-lg shadow-md">
    <div class="flex flex-wrap gap-2.5 mb-5">
      <button id="startBtn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed">Start</button>
      <div class="flex flex-col flex-1 min-w-[200px]">
        <input id="taskInput" type="text" placeholder="Enter text to speak" class="p-2 border border-gray-300 rounded-md" disabled />
        <div class="flex items-center gap-2 mt-2">
          <div id="volumeBar" style="width: 0%"></div>
          <div id="volumeDisplay" class="text-sm text-gray-600">Volume: 0</div>
        </div>
      </div>
      <button id="talkBtn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 disabled:opacity-50" disabled>Talk</button>
      <button id="voiceBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50" disabled>ðŸŽ¤ Voice</button>
    </div>
    <div class="relative h-[400px] overflow-hidden rounded-lg border my-5 bg-gray-100">
      <video id="mediaElement" class="absolute min-h-full min-w-full w-auto h-auto left-1/2 -translate-x-1/2 origin-top scale-150 translate-y-[0%]" autoplay></video>
    </div>
    <div id="status" class="p-2.5 bg-gray-50 border border-gray-300 rounded-md h-[100px] overflow-y-auto font-mono text-sm"></div>
  </div>
  <script>
    const API_CONFIG = {
      apiKey: "ZDZkNzg5OWVjMmY3NGVjYWIzODNhZjkxZjZlNzkxMDMtMTczODY4MzA1Mw==",
      serverUrl: "https://api.heygen.com",
    };
    const ASSEMBLY_API_KEY = "61bdee1fb59a40359276dfa83b8cb1aa";

    let sessionToken, sessionInfo, room, webSocket, mediaStream;
    let audioContext, analyser, mediaRecorder, isVoiceOn = false, recording = false, audioChunks = [], silenceCounter = 0;

    const startBtn = document.getElementById("startBtn");
    const talkBtn = document.getElementById("talkBtn");
    const voiceBtn = document.getElementById("voiceBtn");
    const taskInput = document.getElementById("taskInput");
    const statusElement = document.getElementById("status");
    const mediaElement = document.getElementById("mediaElement");

    const updateStatus = msg => {
      statusElement.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      statusElement.scrollTop = statusElement.scrollHeight;
    };

    const enableControls = (state) => {
      taskInput.disabled = !state;
      talkBtn.disabled = !state;
      voiceBtn.disabled = !state;
    };

    const getSessionToken = async () => {
      const res = await fetch(`${API_CONFIG.serverUrl}/v1/streaming.create_token`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Api-Key": API_CONFIG.apiKey },
      });
      sessionToken = (await res.json()).data.token;
      updateStatus("Session token obtained");
    };

    const connectWebSocket = async (sessionId) => {
      const wsUrl = `wss://${new URL(API_CONFIG.serverUrl).hostname}/v1/ws/streaming.chat?session_id=${sessionId}&session_token=${sessionToken}`;
      webSocket = new WebSocket(wsUrl);
      webSocket.onmessage = (e) => console.log("WS:", JSON.parse(e.data));
    };

    const createSession = async () => {
      if (!sessionToken) await getSessionToken();
      const res = await fetch(`${API_CONFIG.serverUrl}/v1/streaming.new`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${sessionToken}` },
        body: JSON.stringify({ quality: "high", avatar_name: "Dexter_Lawyer_Sitting_public", voice: { rate: 1.0 }, version: "v2", video_encoding: "H264" })
      });
      sessionInfo = (await res.json()).data;

      room = new LivekitClient.Room();
      room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
        mediaStream.addTrack(track.mediaStreamTrack);
        if (mediaStream.getVideoTracks().length && mediaStream.getAudioTracks().length) {
          mediaElement.srcObject = mediaStream;
        }
      });
      mediaStream = new MediaStream();
      await room.prepareConnection(sessionInfo.url, sessionInfo.access_token);
      await connectWebSocket(sessionInfo.session_id);
      updateStatus("Session created");
    };

    const startStreaming = async () => {
      await fetch(`${API_CONFIG.serverUrl}/v1/streaming.start`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${sessionToken}` },
        body: JSON.stringify({ session_id: sessionInfo.session_id }),
      });
      await room.connect(sessionInfo.url, sessionInfo.access_token);
      enableControls(true);
      updateStatus("Streaming started");
    };

    const sendText = async (text) => {
      if (!sessionInfo) return;
      await fetch(`${API_CONFIG.serverUrl}/v1/streaming.task`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${sessionToken}` },
        body: JSON.stringify({ session_id: sessionInfo.session_id, text, task_type: "talk" }),
      });
      updateStatus(`Sent: ${text}`);
    };

    const processAudio = async () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const upload = await fetch("https://api.assemblyai.com/v2/upload", {
        method: "POST", headers: { authorization: ASSEMBLY_API_KEY }, body: blob
      });
      const { upload_url } = await upload.json();
      const transcript = await fetch("https://api.assemblyai.com/v2/transcript", {
        method: "POST",
        headers: { authorization: ASSEMBLY_API_KEY, "content-type": "application/json" },
        body: JSON.stringify({ audio_url: upload_url })
      });
      const { id } = await transcript.json();
      const poll = async () => {
        const res = await fetch(`https://api.assemblyai.com/v2/transcript/${id}`, {
          headers: { authorization: ASSEMBLY_API_KEY }
        });
        const { status, text } = await res.json();
        if (status === "completed" && text) {
          taskInput.value = text;
          sendText(text);
        } else if (status !== "completed") {
          setTimeout(poll, 1000);
        }
      };
      poll();
    };

    const checkVolume = () => {
      const data = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(data);
      const vol = data.reduce((a, b) => a + b, 0) / data.length;
      document.getElementById('volumeDisplay').textContent = `Volume: ${vol.toFixed(1)}`;
      document.getElementById('volumeBar').style.width = `${Math.min(100, vol * 2)}%`;
      document.getElementById('volumeBar').style.background = vol > 10 ? 'red' : 'green';

      if (isVoiceOn) {
        if (vol > 5) {
          silenceCounter = 0;
          if (!recording) {
            recording = true;
            audioChunks = [];
            mediaRecorder.start();
          }
        } else if (recording) {
          silenceCounter++;
          if (silenceCounter > 15) {
            recording = false;
            mediaRecorder.stop();
          }
        }
      }
      requestAnimationFrame(checkVolume);
    };

    const initVoice = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new AudioContext();
      analyser = audioContext.createAnalyser();
      const source = audioContext.createMediaStreamSource(stream);
      source.connect(analyser);
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = processAudio;
      checkVolume();
    };

    startBtn.onclick = async () => {
      await createSession();
      await startStreaming();
    };

    talkBtn.onclick = () => {
      const text = taskInput.value.trim();
      if (text) sendText(text);
      taskInput.value = "";
    };

    voiceBtn.onclick = async () => {
      if (!audioContext) await initVoice();
      isVoiceOn = !isVoiceOn;
      voiceBtn.textContent = isVoiceOn ? 'ðŸ”´ Listening...' : 'ðŸŽ¤ Voice';
    };

    window.addEventListener('beforeunload', () => {
      if (!sessionInfo) return;
      fetch(`${API_CONFIG.serverUrl}/v1/streaming.stop`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${sessionToken}` },
        body: JSON.stringify({ session_id: sessionInfo.session_id }),
        keepalive: true
      });
      if (webSocket) webSocket.close();
      if (room) room.disconnect();
      mediaElement.srcObject = null;
    });
  </script>
</body>
</html>
